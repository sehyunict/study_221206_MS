<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="mybatis.main">

	<resultMap type="MainRankVo" id="rankList">
		<result column="music_no" property="music_no"/>
		<result column="music_title" property="music_title"/>
		<result column="artist_name" property="artist_name"/>
		<result column="album_title" property="album_title"/>
		<result column="music_like" property="music_like"/>
		<result column="member_like" property="member_like"/>
	</resultMap>
	
	<resultMap type="MainPlayListVo" id="playList">
		<result column="now_playList_no" property="now_playList_no"/>
		<result column="music_no" property="music_no"/>
		<result column="music_title" property="music_title"/>
		<result column="artist_name" property="artist_name"/>
		<result column="now_playList_count" property="now_playList_count"/>
		<result column="now_playList_date" property="now_playList_date"/>
	</resultMap>
  
	<select id="selectRankList" resultMap="rankList" parameterType="int" >
		<![CDATA[
			SELECT
			    T1.music_no
			  , T1.music_title
			  , (SELECT artist_name
			    FROM TN_MS_ARTIST
			    WHERE T1.artist_no = artist_no) artist_name
			  , (SELECT album_title
			    FROM TN_MS_ALBUM
			    WHERE T1.album_no = album_no) album_title
			  , T1.music_like
			  , DECODE(T2.music_no, NULL, 0, 1) member_like 
			FROM
			    (SELECT
			        ROWNUM
			      , music_no
			      , music_title
			      , artist_no
			      , album_no
			      , music_like
			    FROM TN_MS_MUSIC
			    ORDER BY
			        music_like DESC
			      , music_no) T1
			  , (SELECT music_no
			    FROM TN_MS_LIKE_MUSIC
			    WHERE member_no = #{memberNo}) T2
			WHERE
			    T1.music_no = T2.music_no(+)
			  AND ROWNUM <= 50
	    ]]>
	</select>
	
	<select id="selectPlayList" parameterType="int" resultMap="playList">
		SELECT
		    T1.now_playList_no
		  , T1.music_no
		  , T3.music_title
		  , (SELECT artist_name
		    FROM TN_MS_ARTIST
		    WHERE T3.artist_no = artist_no) artist_name
		  , T1.now_playList_count
		  , T1.now_playList_date
		FROM
		    TN_MS_NOW_PLAYLIST T1
		  , TN_MS_MEMBER T2
		  , TN_MS_MUSIC T3
		WHERE
		    T1.member_no = T2.member_no
		  AND T1.music_no = T3.music_no
		  AND T2.member_no = #{memberNo}
		ORDER BY
			T1.now_playList_no DESC
	</select>
	
	<insert id="insertPlayList" parameterType="hashMap">
		INSERT
		INTO TN_MS_NOW_PLAYLIST
		VALUES(
		    SEQ_MS_NOW_PLAYLIST.NEXTVAL
		  , #{memberNo}
		  , #{musicNo}
		  , 0
		  , SYSDATE)
	</insert>
	
	<select id="selectInsertPlayList" parameterType="hashMap" resultMap="playList">
		<![CDATA[
			SELECT
			    T1.now_playList_no
			  , T1.music_no
			  , T3.music_title
			  , (SELECT artist_name
			    FROM TN_MS_ARTIST
			    WHERE T3.artist_no = artist_no) artist_name
			  , T1.now_playList_count
			  , T1.now_playList_date
			FROM
			    TN_MS_NOW_PLAYLIST T1
			  , TN_MS_MEMBER T2
			  , TN_MS_MUSIC T3
			  , (SELECT
			        ROWNUM RN
			      , now_playList_no
			    FROM TN_MS_NOW_PLAYLIST
			    WHERE member_no = #{memberNo}
			    ORDER BY now_playList_no DESC) T4
			WHERE
			    T1.member_no = T2.member_no
			  AND T1.music_no = T3.music_no
			  AND T1.now_playList_no = T4.now_playList_no
			  AND T4.RN <= #{insertSize}
			ORDER BY T1.now_playList_no
	    ]]>
	</select>
	
	<delete id="deletePlayList" parameterType="int">
		DELETE
		FROM TN_MS_NOW_PLAYLIST
		WHERE now_playList_no = #{musicNo}
	</delete>
	
	<insert id="insertLike" parameterType="hashMap">
		INSERT
		INTO TN_MS_LIKE_MUSIC
		VALUES(
		    SEQ_MS_LIKE_MUSIC.NEXTVAL
		  , #{memberNo}
		  , #{musicNo}
		  , SYSDATE)
	</insert>
	
	<update id="updateInertLike" parameterType="int">
		UPDATE TN_MS_MUSIC
		SET music_like = music_like + 1
		WHERE music_no = #{musicNo}
	</update>
	
	<delete id="deleteLike" parameterType="hashMap">
		DELETE
		FROM TN_MS_LIKE_MUSIC
		WHERE
			member_no = #{memberNo}
		  AND music_no = #{musicNo}
	</delete>
	
	<update id="updateDeleteLike" parameterType="int">
		UPDATE TN_MS_MUSIC
		SET music_like = music_like - 1
		WHERE music_no = #{musiNo}
	</update>
	
	<update id="updatePlayCount" parameterType="int">
		UPDATE TN_MS_MUSIC
		SET music_playCount = music_playCount + 1
		WHERE music_no = #{musicNo}
	</update>
	
</mapper>